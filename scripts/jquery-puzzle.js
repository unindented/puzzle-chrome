(function(a){var b;return a.fn.puzzle=function(c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;k=32,g=32,i=3,e=9,f=3,d=9,j=1,h=1,q={rows:4,cols:4,hole:16,shuffle:!1,numbers:!1,control:{shufflePieces:!0,confirmShuffle:!0,toggleNumbers:!0,toggleOriginal:!0,counter:!0,timer:!0,pauseTimer:!1},success:{fadeOriginal:!0,callback:void 0,callbackTimeout:300},animation:{shuffleRounds:3,shuffleSpeed:800,slidingSpeed:200,fadeOriginalSpeed:600},style:{gridSize:2,gridOverlap:!0,backgroundOpacity:.1}},y={shufflePieces:chrome.i18n.getMessage("msg_shuffle"),confirmShuffle:chrome.i18n.getMessage("msg_confirm_shuffle"),toggleNumbers:chrome.i18n.getMessage("msg_numbers"),toggleOriginal:chrome.i18n.getMessage("msg_original"),moves:chrome.i18n.getMessage("msg_moves"),seconds:chrome.i18n.getMessage("msg_seconds")},c&&!c.hole&&(c.rows||c.cols)&&(c.hole=(c.rows||q.rows)*(c.cols||q.cols)),c=a.extend(!0,{},q,c),v=c.rows,o=c.cols,u=c.hole,p=c.control,x=c.success,l=c.animation,w=c.style;if(v<i||v>e)v=q.rows;if(o<f||o>d)o=q.rows;if(u<1||u>v*o)u=v*o;return u--,l.slidingSpeed<j&&(l.slidingSpeed=j),l.shuffleSpeed<j&&(l.shuffleSpeed=j),l.fadeOriginalSpeed<j&&(l.fadeOriginalSpeed=j),l.shuffleRounds<h&&(l.shuffleRounds=h),n=function(a){var b,c,d,e;for(c=0,e=a.length;0<=e?c<e:c>e;0<=e?c++:c--){d=c<u?c:c+1,b=parseInt(a.eq(c).attr("current"));if(d!==b)return!1}return!0},m=function(a){var b,c,d,e,f,g;d=1;for(b=1,e=v*o-1;1<=e?b<=e:b>=e;1<=e?b++:b--)for(c=f=b+1,g=v*o;f<=g?c<=g:c>=g;f<=g?c++:c--)d*=(a[b-1]-a[c-1])/(b-c);return Math.round(d)===1},s=function(a,b){return parseInt(a)*o+parseInt(b)},t=function(a){return{row:Math.floor(a/o),col:a%o}},r=function(a){var b;b=a.css("border-left-width");if(a.css("border-left-style")!=="none")switch(b){case"thin":return 2;case"medium":return 4;case"thick":return 6;default:return parseInt(b)||0}return 0},this.filter("img").each(function(){var d,e,f,g,h,i,j,k,q,z,A,B,C,D;return h=a(this),q=!1,C=!1,B=c.shuffle,z=0,A=0,D=void 0,j=u,g=a("<div/>").addClass("wrapper").append(f),d=a("<div/>").addClass("background").appendTo(g),f=a("<div/>").addClass("piece").appendTo(g),e=a("<div/>").attr("class",h.attr("class")||"").addClass("puzzle").append(g),h.replaceWith(e),e.attr("id",h.attr("id")||""),i={gui:{border:r(e),padding:{left:parseInt(e.css("padding-left"))||0,right:parseInt(e.css("padding-right"))||0,top:parseInt(e.css("padding-top"))||0,bottom:parseInt(e.css("padding-bottom"))||0}},wrapper:{border:r(g),padding:parseInt(g.css("padding-left"))||0},background:{border:r(d)},piece:{border:r(f)}},e.removeAttr("id"),e.replaceWith(h),h.one("load",function(){var d,e,f,g,k,r,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,ba,bb,bc,bd,be,bf,bg,bh,bi,bj;be=w.gridSize===0&&w.gridOverlap,T=o*2*i.piece.border+(o-1)*w.gridSize,S=v*2*i.piece.border+(v-1)*w.gridSize,be&&(T-=(o-1)*i.piece.border,S-=(v-1)*i.piece.border),h.css({height:"auto",width:"auto",visibility:"visible"}),bj=Math.floor((h.width()-T)/o),Y=Math.floor((h.height()-S)/v),W=o*bj+T,V=v*Y+S,ba=h.attr("src"),bi=bj+2*i.piece.border+w.gridSize,bh=Y+2*i.piece.border+w.gridSize,X=function(a,b){var c;return c={left:i.wrapper.padding+b*bi,top:i.wrapper.padding+a*bh},be&&(c.left-=b*i.piece.border,c.top-=a*i.piece.border),c},bf=function(a,b){var c,e,g,h,i,n,r,s,x,G,H,J,K,L;if(b){if(M.is(".disabled"))return!1;if(q)return!1;if(z>0&&p.confirmShuffle&&!window.confirm(y.confirmShuffle))return!1;q=!0,C&&(F.removeClass("solved"),d.fadeTo(l.fadeOriginalSpeed,w.backgroundOpacity,function(){return d.remove().prependTo(P),f.removeClass("disabled")}))}D&&D.stop(),C=!1,B=!0,z=0,A=0,E&&E.removeClass("disabled"),k&&k.val(z),N&&N.val(A),G=[],h=0;while(h<a){g=[];for(i=0,J=v*o;0<=J?i<J:i>J;0<=J?i++:i--)g[i]=i;g.splice(u,1),G[h]=[];for(i=0,K=v*o;0<=K?i<K:i>K;0<=K?i++:i--){if(i===u){G[h][i]=u;continue}x=Math.floor(Math.random()*g.length),G[h][i]=g[x],g.splice(x,1)}(h+1<a||m(G[h]))&&h++}e=0,L=[];for(h=0;0<=a?h<a:h>a;0<=a?h++:h--)n=h+1===a,L.push(function(){var a,d;d=[];for(i=0,a=G[h].length;0<=a?i<a:i>a;0<=a?i++:i--){if(i===u){n&&(j=u);continue}s=G[h][i],s>u&&(s-=1),c=I.eq(s),H=t(i),r=X(H.row,H.col),n&&c.attr("current",i),b==null?d.push(c.css({left:r.left,top:r.top})):d.push(c.animate({left:r.left,top:r.top},b,null,function(){e++;if(e===l.shuffleRounds*(v*o-1))return q=!1,e=0}))}return d}());return L},P=a("<div/>").addClass("wrapper").css({width:W,height:V,borderWidth:i.wrapper.border,padding:i.wrapper.padding,position:"relative",overflow:"hidden"}),L=a("<div/>").addClass("piece").css({width:bj,height:Y,backgroundImage:"url("+ba+")",borderWidth:i.piece.border,position:"absolute",overflow:"hidden"}).append(a("<span/>").addClass("number")),I=a([]);for(Z=0;0<=v?Z<v:Z>v;0<=v?Z++:Z--)for(bc=0;0<=o?bc<o:bc>o;0<=o?bc++:bc--){bb=s(Z,bc);if(bb===u)continue;bd=X(Z,bc),Q=-1*(bc*bi+i.piece.border),R=-1*(Z*bh+i.piece.border),be&&(Q+=bc*i.piece.border,R+=Z*i.piece.border),I=I.add(L.clone().css({left:bd.left,top:bd.top,backgroundPosition:""+Q+"px "+R+"px"}).attr("current",bb).appendTo(P).children().text(bb+1).end())}c.shuffle&&bf(1),d=a("<div/>").addClass("background").css({width:W,height:V,left:i.wrapper.padding-i.background.border,top:i.wrapper.padding-i.background.border,backgroundImage:"url("+ba+")",position:"absolute",opacity:w.backgroundOpacity}).prependTo(P),g=a("<div/>").addClass("controls").css({padding:i.wrapper.padding}),e=void 0,M=void 0,G=void 0,H=void 0;if(p.shufflePieces||p.toggleNumbers||p.toggleOriginal)e=a("<div/>").addClass("buttons").appendTo(g),J=a("<a/>"),p.shufflePieces&&(M=J.clone().addClass("shuffle").text(y.shufflePieces).appendTo(e)),p.toggleNumbers&&(G=J.clone().addClass("numbers").text(y.toggleNumbers).appendTo(e),c.numbers&&G.addClass("toggle")),p.toggleOriginal&&(H=J.clone().addClass("original").text(y.toggleOriginal).appendTo(e)),f=e.children();E=void 0,r=void 0,O=void 0;if(p.counter||p.timer)E=a("<div/>").addClass("display").appendTo(g),K=a("<input/>").attr("readonly","readonly").val(0),p.counter&&(k=K.clone().appendTo(E).after(y.moves)),p.timer&&(N=K.clone().appendTo(E).after(y.seconds)),c.shuffle||E.addClass("disabled");return F=a("<div/>").attr("class",h.attr("class")||"").addClass("puzzle").css({width:W+2*(i.wrapper.padding+i.wrapper.border),overflow:"hidden"}).append(P).append(g),h.replaceWith(F),_=h.attr("id"),_&&F.attr("id",_),c.numbers||I.children().hide(),F.mousedown(function(){return!1}),f.mousedown(function(){if(!a(this).is(".disabled"))return a(this).addClass("down")}),f.mouseout(function(){return a(this).removeClass("down")}),f.mouseup(function(){return a(this).removeClass("down")}),I.click(function(){var c,d,e,f;return q?!1:C?!1:(q=!0,c=a(this),d=c.attr("current"),f=t(d),e=t(j),Math.abs(f.row-e.row)+Math.abs(f.col-e.col)!==1?(q=!1,!1):(bd=X(e.row,e.col),c.attr("current",j),j=d,B&&z++,k&&k.val(z),z===1&&(D||(D=new b(333,function(a){A=Math.floor(a/1e3);if(N)return N.val(A)})),D.start()),c.animate({left:bd.left,top:bd.top},l.slidingSpeed,null,function(){return B?(C=n(I),C?(D&&D.stop(),B=!1,F.addClass("solved"),window.setTimeout(U,100)):q=!1):q=!1})))}),p.shufflePieces&&M.click(function(){return bf(l.shuffleRounds,l.shuffleSpeed)}),p.toggleNumbers&&G.click(function(){return G.is(".disabled")?!1:G.is(".toggle")?(G.removeClass("toggle"),I.children().hide()):(G.addClass("toggle"),I.children().show())}),p.toggleOriginal&&H.click(function(){return H.is(".disabled")?!1:q?!1:(q=!0,H.is(".toggle")?(p.shufflePieces&&M.removeClass("disabled"),p.toggleNumbers&&G.removeClass("disabled"),H.removeClass("toggle"),d.fadeTo(l.fadeOriginalSpeed,w.backgroundOpacity,function(){return a(this).prependTo(P),p.pauseTimer&&D&&D.resume(),q=!1})):(p.shufflePieces&&M.addClass("disabled"),p.toggleNumbers&&G.addClass("disabled"),H.addClass("toggle"),p.pauseTimer&&D&&D.pause(),d.appendTo(P).fadeTo(l.fadeOriginalSpeed,1,function(){return q=!1})),!1)}),U=function(){return x.fadeOriginal?(p.toggleOriginal&&H.addClass("disabled"),p.toggleNumbers&&G.addClass("disabled"),d.appendTo(P).fadeTo(l.fadeOriginalSpeed,1,function(){return q=!1,bg()})):(q=!1,bg())},bg=function(){if(a.isFunction(x.callback))return setTimeout(function(){return x.callback({moves:z,seconds:A})},x.callbackTimeout)}}),k=setInterval(function(){if(h[0].complete)return clearInterval(k),h.trigger("load")},333)}).end()},a(document).ready(function(){return a("img.puzzle").each(function(){return a(this).puzzle()})}),b=function(){function a(a,b){this.interval=a,this.callback=b,this.timeout=void 0,this.startTime=void 0,this.startPauseTime=void 0,this.totalPause=0}return a.prototype.run=function(){var a=this;return this.update((new Date).getTime()),this.timeout=setTimeout(function(){return a.run()},this.interval)},a.prototype.update=function(a){return this.callback(a-this.totalPause-this.startTime)},a.prototype.start=function(){return this.startTime!=null?!1:(this.startTime=(new Date).getTime(),this.run())},a.prototype.stop=function(){var a;return this.startTime==null?!1:(clearTimeout(this.timeout),a=(new Date).getTime(),this.startPauseTime!=null&&(this.totalPause+=a-this.startPauseTime),this.update(a),this.startTime=void 0,this.startPauseTime=void 0,this.totalPause=0)},a.prototype.pause=function(){return this.startTime==null||this.startPauseTime!=null?!1:(clearTimeout(this.timeout),this.startPauseTime=(new Date).getTime())},a.prototype.resume=function(){return this.startPauseTime==null?!1:(this.totalPause+=(new Date).getTime()-this.startPauseTime,this.startPauseTime=void 0,this.run())},a}()})(jQuery);